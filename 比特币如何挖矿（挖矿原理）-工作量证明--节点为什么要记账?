
在区块链记账原理一篇，我们了解到记账是把交易记录、交易时间、账本序号、上一个Hash值等信息计算Hash打包的过程。
我们知道所有的计算和存储是需要消耗计算机资源的，既然要付出成本，那节点为什么还要参与记账呢?
在中本聪的设计里，完成记账的节点可以获得系统给予的一定数量的比特币奖励，这个奖励的过程也就是比特币的发行过程，因此大家形象的把记账称为挖矿
  
  记账工作
  出现记账不一致的问题，比特币系统引入工作量证明来解决这个问题，规则如下:
      1、一段时间内(10分钟左右，具体时间会与密码学难题难度互相影响)只有一个人可以记账成功。
      2、通过解决密码学难题(即工作量证明)竞争获得唯一记账权。
      3、其他节点复制记账结果。
  不过在进行工作量证明之前，记账节点会做进行如下准备工作:
      1、收集广播中还没有被记录账本的原始交易记录。
      2、检查每个交易信息中付款地址有没有足够的余额。
      3、验证交易是否有正确的签名。
      4、把验证通过的交易信息进行打包记录。
      5、添加一个奖励交易: 给自己的地址增加12.5比特币。
   
   
  工作量证明
  
  区块链记账原理我们了解到，每次记账的时候会把上一个快的Hash值和当前的账页信息一起作为原始信息进行Hash.
  如果仅仅是这样，显然每个人都可以很轻松的完成记账。
  为了保证10分钟左右只有一个人可以记账，就必须要提高记账的难度，使得Hash的结果必须以若干个0开头，同时为了满足这个条件，在进行Hash时引入一个随机数变量。
  区块链有个特点： 虽然大家都在采矿，但挖到矿的速度时均匀的，比特币平均每10分钟产出一个区块，这个速度基本时不变的。
 
 区块链如何动态调节，以保证匀速生成区块?
  区块是怎么生成的?
    对最新的区块进行两次SHA256计算，得到的256bit哈希结果，高位48bit必须是0x00000000FFF,才算新区块有效。
    可以认为哈希的结果是完全随机的，要得出前48bit必须是0x00000000FFFF的哈希结果，就如同连续抛了48次硬币，每次都得到我们想要的结果，其概率是(1/2)^48,
    所以概率非常小，生成区块的难度很高。
  
  区块如何保证生成速度均速?
    假设期望比特币全球区块链每10分钟生成一个区块，需要设定一个动态调节机制，每两周做一次统计:
        1、如果统计结果是，最近两周平均每5分钟就生成一个区块，说明生成太快了，需要变慢50%，
        2、如果统计结果是，最近两周平均每20分钟才生成了一个区块，说明生成太慢了，需要加速一倍。
 如何控制加速和变慢呢?
    区块链中都有一个难度系数，可以调节区块生成的变快与变慢，难度系数影响的是，区块头哈希结果，有多少bit必须预期相同。
    例如: 
        原计划哈希结果高位48bit符合预期，才算挖矿成功，现在改为，49bit符合预期，才算挖矿成功，这样得到预期hash的概率就降低了，挖矿就会变慢。
        相反，如果改为，47bit哈希结果符合预期，就算挖矿成功，这样得到预期hash的概率就变高了，挖矿就会变快。
 总结，如何保证全球均速挖矿?
    1、需要定期统计，动态加速或减慢生成速度。
    2、通过难度系数，影响hash结果多少位必须符合预期，才算合法的区块，来控制速度。
    
    
    
    为了保证10分钟左右只有一个人可以记账，就必须要提高记账的难度，使得Hash的结果必须以若干个0/开头。同时为了满足这个条件，在进行Hash时引入一个随机数变量nonce
    
    用伪代码表示一下:
        1、没有难度时为: Hash(上一个Hash值，交易记录集) = 456635BCD
        2、Hash(上一个Hash值，交易记录集，随机数) = 0000aFD635BCD
    我们知道改变Hash的原始信息的任何一部分，Hash值也会随之不断的变化，因此在运算Hash时，不断的改变随机数的值，总可以找到一个随机数使得Hash
    的结果以若干个0开头（下文把这个过程称为猜谜），率先找到随机数的节点就获得此次记账的唯一记账权。
    


计算量分析
    
验证

  在节点成功找到满足的Hash值之后，会马上对全网进行广播打包区块，网络的节点收到广播打包区块，会立刻对其进行验证。
  如果验证通过，则表明已经有节点成功解谜（找到一个随机数使得Hash的结果以若干个0开头）
  网络中只有最快解谜的区块，才会添加到账本中，其他的节点进行复制，这样就保证了整个账本的唯一性。
  
  假如节点有任何的作弊行为，都会导致网络的节点验证不通过，直接丢弃其打包的区块，这个区块就无法记录到总账本中，作弊的节点耗费的成本就白费了，
  因此在巨大的挖矿成本，也使得矿工自觉自愿的遵守比特币系统的共识协议，也就确保了整个系统的安全。
  
  
  
    说明
矿工的收益其实不仅仅包含新发行的12.5比特币奖励，同时还有交易费收益（本文忽略一些细节是为了让主干更清晰）。

有兴趣的同学可以看看图中区块都包含了那些信息，红箭头标示出的是本文涉及的信息。

本文中有提到共识协议，比特币共识协议主要是由工作量证明和最长链机制 两部分组成，请阅读比特币如何达成共识 - 最长链的选择。
    
  
